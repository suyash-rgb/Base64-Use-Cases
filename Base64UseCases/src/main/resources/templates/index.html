<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <title>WebSocket PDF Transfer</title>
  <meta charset="UTF-8">
  <style>
    .download-link {
      display: inline-block;
      margin: 8px 0;
      padding: 6px 12px;
      background-color: #4CAF50;
      color: white;
      text-decoration: none;
      border-radius: 4px;
    }
    .download-link:hover {
      background-color: #45a049;
    }
  </style>
</head>
<body>
<h2>Send a PDF via WebSocket</h2>
<input type="file" id="fileInput" accept="application/pdf" />
<button id="sendBtn">Send PDF</button>
<hr>
<div id="log"></div>

<!-- SockJS and STOMP from WebJars -->
<script src="/webjars/sockjs-client/1.5.1/sockjs.min.js"></script>
<script src="/webjars/stomp-websocket/2.3.4/stomp.min.js"></script>

<script>
  const socket = new SockJS('/ws');
  const stompClient = Stomp.over(socket);

  stompClient.connect({}, () => {
    stompClient.subscribe('/topic/files', msg => {
      const payload = JSON.parse(msg.body);
      console.log("Received message:", payload);

      const log = document.getElementById('log');

      if (payload.base64) {
        const byteChars = atob(payload.base64);
        const byteNumbers = new Array(byteChars.length);
        for (let i = 0; i < byteChars.length; i++) {
          byteNumbers[i] = byteChars.charCodeAt(i);
        }
        const byteArray = new Uint8Array(byteNumbers);
        const blob = new Blob([byteArray], { type: 'application/pdf' });
        const url = URL.createObjectURL(blob);

        const link = document.createElement('a');
        link.href = url;
        link.download = payload.filename || 'file.pdf';
        link.textContent = `ðŸ“„ Download ${payload.filename || 'file.pdf'}`;
        link.className = 'download-link';

        log.appendChild(link);
        log.appendChild(document.createElement('br'));
      } else {
        const ack = document.createElement('div');
        ack.textContent = `Ack: ${payload.filename} - ${payload.status}`;
        log.appendChild(ack);
      }
    });
  });

  document.getElementById('sendBtn').addEventListener('click', () => {
    const input = document.getElementById('fileInput');
    if (!input.files.length) return;

    const file = input.files[0];
    const reader = new FileReader();

    reader.onload = () => {
      const base64 = reader.result.split(',')[1]; // Strip data URI prefix
      const payload = { filename: file.name, base64 };
      console.log("Sending payload:", payload);
      stompClient.send('/app/upload', {}, JSON.stringify(payload));
    };

    reader.readAsDataURL(file); // Produces base64-encoded string
  });
</script>
</body>
</html>